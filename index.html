<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi Siswa</title>
  <link rel="icon" href="data:,">
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    .sidebar {
      transition: all 0.3s;
    }
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }
    .notification {
      animation: slideIn 0.5s, fadeOut 0.5s 2.5s forwards;
    }
    @keyframes slideIn {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .progress-bar {
      transition: width 0.5s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Connection Status -->
  <div id="connectionStatus" class="fixed top-0 left-0 right-0 bg-yellow-500 text-white text-center py-1 hidden">
    <i class="fas fa-exclamation-triangle mr-2"></i>
    <span>Anda sedang offline. Beberapa fitur mungkin terbatas.</span>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl flex items-center">
      <i class="fas fa-spinner fa-spin text-blue-500 text-2xl mr-3"></i>
      <span class="text-lg">Memuat data...</span>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden"></div>

  <!-- Mobile Menu Button -->
  <button id="mobileMenuButton" class="md:hidden fixed top-4 left-4 z-50 bg-blue-600 text-white p-2 rounded-lg shadow">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 bg-blue-800 text-white p-4 shadow-lg z-40">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <img id="logo" src="" alt="Logo" class="w-10 h-10 rounded-full mr-2">
        <h1 id="appTitle" class="text-xl font-bold"></h1>
      </div>
    </div>
    
    <div id="adminMenu" class="hidden">
      <h2 class="text-lg font-semibold mb-2">Menu Admin</h2>
      <ul class="space-y-2">
        <li><a href="#" onclick="showSection('dashboard')" class="block py-2 px-3 rounded hover:bg-blue-700"><i class="fas fa-tachometer-alt mr-2"></i> Dashboard</a></li>
        <li><a href="#" onclick="showSection('siswa')" class="block py-2 px-3 rounded hover:bg-blue-700"><i class="fas fa-users mr-2"></i> Data Siswa</a></li>
        <li><a href="#" onclick="showSection('absen')" class="block py-2 px-3 rounded hover:bg-blue-700"><i class="fas fa-clipboard-list mr-2"></i> Rekap Absen</a></li>
        <li><a href="#" onclick="showSection('settings')" class="block py-2 px-3 rounded hover:bg-blue-700"><i class="fas fa-cog mr-2"></i> Pengaturan</a></li>
        <li><a href="#" onclick="showSection('libur')" class="block py-2 px-3 rounded hover:bg-blue-700"><i class="fas fa-calendar-alt mr-2"></i> Hari Libur</a></li>
        <li><a href="#" onclick="showSection('manual')" class="block py-2 px-3 rounded hover:bg-blue-700"><i class="fas fa-pen mr-2"></i> Absen Manual</a></li>
        <li><a href="#" onclick="showSection('logs')" class="block py-2 px-3 rounded hover:bg-blue-700"><i class="fas fa-history mr-2"></i> Log Sistem</a></li>
      </ul>
    </div>
    
    <div id="publicMenu" class="mt-6">
      <h2 class="text-lg font-semibold mb-2">Menu Absen</h2>
      <ul class="space-y-2">
        <li><a href="#" onclick="showSection('live')" class="block py-2 px-3 rounded hover:bg-blue-700"><i class="fas fa-qrcode mr-2"></i> Live Absen</a></li>
      </ul>
    </div>
    
    <div class="absolute bottom-4 left-4 right-4">
      <button id="logoutBtn" onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded hidden">
        <i class="fas fa-sign-out-alt mr-2"></i> Logout
      </button>
      <button id="loginBtn" onclick="showSection('login')" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">
        <i class="fas fa-sign-in-alt mr-2"></i> Login Admin
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="ml-0 md:ml-64 p-4 transition-all duration-300">
    <!-- Login Section -->
    <div id="loginSection" class="section bg-white rounded-lg shadow p-6 max-w-md mx-auto">
      <h2 class="text-2xl font-bold mb-6 text-center">Login Admin</h2>
      <form id="loginForm" onsubmit="event.preventDefault(); login();">
        <div class="mb-4">
          <label for="username" class="block text-gray-700 mb-2">Username</label>
          <input type="text" id="username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-6">
          <label for="password" class="block text-gray-700 mb-2">Password</label>
          <input type="password" id="password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
          <i class="fas fa-sign-in-alt mr-2"></i> Login
        </button>
      </form>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="section hidden">
      <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-2">Total Siswa</h3>
          <p id="totalSiswa" class="text-3xl font-bold text-blue-600">0</p>
          <p class="text-sm text-gray-500 mt-1"><span id="activeSiswa">0</span> Aktif</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-2">Absen Hari Ini</h3>
          <p id="absenHariIni" class="text-3xl font-bold text-green-600">0</p>
          <p class="text-sm text-gray-500 mt-1"><span id="presentPercentage">0</span>% Kehadiran</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-2">Terlambat Hari Ini</h3>
          <p id="terlambatHariIni" class="text-3xl font-bold text-red-600">0</p>
          <p class="text-sm text-gray-500 mt-1"><span id="latePercentage">0</span>% dari absen</p>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Aktivitas Terakhir</h3>
          <button onclick="loadDashboardData()" class="text-blue-600 hover:text-blue-800">
            <i class="fas fa-sync-alt mr-1"></i> Refresh
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b">NIS</th>
                <th class="py-2 px-4 border-b">Nama</th>
                <th class="py-2 px-4 border-b">Kelas</th>
                <th class="py-2 px-4 border-b">Waktu</th>
                <th class="py-2 px-4 border-b">Status</th>
              </tr>
            </thead>
            <tbody id="lastActivityTable">
              <!-- Data akan diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Data Siswa Section -->
    <div id="siswaSection" class="section hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Data Siswa</h2>
        <div class="flex space-x-2">
          <button onclick="showAddSiswaModal()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
            <i class="fas fa-plus mr-2"></i> Tambah
          </button>
          <button onclick="loadSiswaData()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">
            <i class="fas fa-sync-alt mr-2"></i> Refresh
          </button>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 border-b">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="mb-2 md:mb-0">
              <label for="siswaFilter" class="block text-gray-700 mb-1">Filter:</label>
              <select id="siswaFilter" onchange="filterSiswaTable()" class="px-3 py-1 border rounded-lg">
                <option value="all">Semua</option>
                <option value="active">Aktif</option>
                <option value="inactive">Non-Aktif</option>
              </select>
            </div>
            <div class="flex items-center">
              <input type="text" id="siswaSearch" placeholder="Cari..." 
                class="px-3 py-1 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                onkeyup="searchSiswa()">
              <button class="ml-2 text-gray-500 hover:text-gray-700">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-3 px-4 text-left">NIS</th>
                <th class="py-3 px-4 text-left">Nama</th>
                <th class="py-3 px-4 text-left">Kelas</th>
                <th class="py-3 px-4 text-left">RFID</th>
                <th class="py-3 px-4 text-left">Status</th>
                <th class="py-3 px-4 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="siswaTableBody">
              <!-- Data akan diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t flex justify-between items-center">
          <div id="siswaTableInfo" class="text-sm text-gray-600"></div>
          <div class="flex space-x-2">
            <button id="prevPageBtn" onclick="prevPage()" class="px-3 py-1 border rounded-lg disabled:opacity-50" disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="pageInfo" class="px-3 py-1">1/1</span>
            <button id="nextPageBtn" onclick="nextPage()" class="px-3 py-1 border rounded-lg disabled:opacity-50" disabled>
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Rekap Absen Section -->
    <div id="absenSection" class="section hidden">
      <h2 class="text-2xl font-bold mb-6">Rekap Absensi</h2>
      
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
          <h3 class="text-lg font-semibold mb-2 md:mb-0">Filter Data</h3>
          <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
            <div>
              <label for="filterDate" class="block text-gray-700 mb-1 text-sm">Tanggal</label>
              <input type="date" id="filterDate" class="px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label for="filterKelas" class="block text-gray-700 mb-1 text-sm">Kelas</label>
              <select id="filterKelas" class="px-3 py-2 border rounded-lg">
                <option value="">Semua Kelas</option>
                <!-- Diisi oleh JavaScript -->
              </select>
            </div>
            <div>
              <label for="filterStatus" class="block text-gray-700 mb-1 text-sm">Status</label>
              <select id="filterStatus" class="px-3 py-2 border rounded-lg">
                <option value="">Semua Status</option>
                <option value="Tepat Waktu">Tepat Waktu</option>
                <option value="Terlambat">Terlambat</option>
                <option value="Awal">Awal</option>
              </select>
            </div>
            <button onclick="loadAbsenData()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg mt-auto">
              <i class="fas fa-filter mr-2"></i> Filter
            </button>
            <button onclick="resetFilter()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg mt-auto">
              <i class="fas fa-sync-alt mr-2"></i> Reset
            </button>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b">NIS</th>
                <th class="py-2 px-4 border-b">Nama</th>
                <th class="py-2 px-4 border-b">Kelas</th>
                <th class="py-2 px-4 border-b">Waktu</th>
                <th class="py-2 px-4 border-b">Status</th>
                <th class="py-2 px-4 border-b">Metode</th>
              </tr>
            </thead>
            <tbody id="absenTableBody">
              <!-- Data akan diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
        <div class="mt-4 flex justify-between items-center">
          <div id="absenTableInfo" class="text-sm text-gray-600"></div>
          <button onclick="exportAbsenData()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg">
            <i class="fas fa-file-export mr-2"></i> Export
          </button>
        </div>
      </div>
    </div>

    <!-- Pengaturan Section -->
    <div id="settingsSection" class="section hidden">
      <h2 class="text-2xl font-bold mb-6">Pengaturan Sistem</h2>
      
      <div class="bg-white rounded-lg shadow p-6">
        <form id="settingsForm" onsubmit="event.preventDefault(); updateSettings();">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-semibold mb-4">Pengaturan Absensi</h3>
              
              <div class="mb-4">
                <label for="jamMasuk" class="block text-gray-700 mb-2">Jam Masuk</label>
                <input type="time" id="jamMasuk" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              </div>
              
              <div class="mb-4">
                <label for="batasTerlambat" class="block text-gray-700 mb-2">Batas Terlambat (menit)</label>
                <input type="number" id="batasTerlambat" min="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              </div>

              <div class="mb-4">
                <label for="modeAbsen" class="block text-gray-700 mb-2">Mode Absen</label>
                <select id="modeAbsen" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="normal">Normal</option>
                  <option value="strict">Ketat</option>
                  <option value="flexible">Fleksibel</option>
                </select>
              </div>
            </div>
            
            <div>
              <h3 class="text-lg font-semibold mb-4">Pengaturan Website</h3>
              
              <div class="mb-4">
                <label for="judulWeb" class="block text-gray-700 mb-2">Judul Website</label>
                <input type="text" id="judulWeb" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              </div>
              
              <div class="mb-4">
                <label for="deskripsiWeb" class="block text-gray-700 mb-2">Deskripsi Website</label>
                <textarea id="deskripsiWeb" rows="2" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
              </div>
              
              <div class="mb-4">
                <label for="logoUrl" class="block text-gray-700 mb-2">URL Logo</label>
                <input type="url" id="logoUrl" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="mt-2 flex items-center">
                  <img id="logoPreview" src="" alt="Logo Preview" class="w-10 h-10 rounded-full mr-2 hidden">
                  <button type="button" onclick="testLogoUrl()" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">
                    Test URL
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" onclick="resetSettingsForm()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
              <i class="fas fa-undo mr-2"></i> Reset
            </button>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg">
              <i class="fas fa-save mr-2"></i> Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Hari Libur Section -->
    <div id="liburSection" class="section hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Hari Libur</h2>
        <div class="flex space-x-2">
          <button onclick="showAddLiburModal()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
            <i class="fas fa-plus mr-2"></i> Tambah
          </button>
          <button onclick="loadLiburData()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">
            <i class="fas fa-sync-alt mr-2"></i> Refresh
          </button>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-3 px-4 text-left">Tanggal</th>
                <th class="py-3 px-4 text-left">Keterangan</th>
                <th class="py-3 px-4 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="liburTableBody">
              <!-- Data akan diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Absen Manual Section -->
    <div id="manualSection" class="section hidden">
      <h2 class="text-2xl font-bold mb-6">Absen Manual</h2>
      
      <div class="bg-white rounded-lg shadow p-6">
        <form id="manualAbsenForm" onsubmit="event.preventDefault(); submitManualAbsen();">
          <div class="mb-4">
            <label for="manualSiswa" class="block text-gray-700 mb-2">Pilih Siswa</label>
            <select id="manualSiswa" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="">-- Pilih Siswa --</option>
              <!-- Data akan diisi oleh JavaScript -->
            </select>
          </div>
          
          <div class="mb-4">
            <label for="manualStatus" class="block text-gray-700 mb-2">Status Absen</label>
            <select id="manualStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="auto">Otomatis (sesuai waktu)</option>
              <option value="Tepat Waktu">Tepat Waktu</option>
              <option value="Terlambat">Terlambat</option>
              <option value="Awal">Awal</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label for="manualWaktu" class="block text-gray-700 mb-2">Waktu Absen</label>
            <input type="datetime-local" id="manualWaktu" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="flex justify-end space-x-3">
            <button type="reset" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
              Batal
            </button>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg">
              <i class="fas fa-check mr-2"></i> Catat Absen
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Live Absen Section -->
    <div id="liveSection" class="section hidden">
      <div class="flex flex-col md:flex-row gap-6">
        <div class="md:w-2/3">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-6">Live Absensi</h2>
            
            <div class="text-center mb-6">
              <div class="text-5xl font-bold mb-2" id="currentTime"></div>
              <div class="text-xl" id="currentDate"></div>
              <div id="liburInfo" class="text-red-600 font-semibold mt-2 hidden">
                <i class="fas fa-calendar-times mr-2"></i> Hari ini adalah hari libur
              </div>
            </div>
            
            <div class="mb-6">
              <label class="block text-gray-700 mb-2">Scan RFID</label>
              <input type="text" id="rfidInput" class="w-full px-3 py-4 text-center text-xl border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tempelkan Kartu RFID" autofocus>
              <p class="text-sm text-gray-500 mt-1">Tekan Enter setelah scan</p>
            </div>
            
            <div class="bg-gray-100 rounded-lg p-4">
              <h3 class="font-semibold mb-2">Last Scan</h3>
              <div id="lastScanInfo" class="text-gray-700">
                Belum ada scan
              </div>
            </div>
          </div>
        </div>
        
        <div class="md:w-1/3">
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">Info Absen Hari Ini</h3>
              <button onclick="loadLiveAbsenData()" class="text-blue-600 hover:text-blue-800">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            
            <div class="space-y-4">
              <div>
                <div class="flex justify-between mb-1">
                  <span class="font-medium">Total Absen</span>
                  <span class="font-bold" id="todayAbsenCount">0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div id="todayAbsenBar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-1 text-right" id="todayAbsenPercentage">0%</div>
              </div>
              
              <div>
                <div class="flex justify-between mb-1">
                  <span class="font-medium">Tepat Waktu</span>
                  <span class="font-bold text-green-600" id="todayOnTimeCount">0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div id="todayOnTimeBar" class="bg-green-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-1 text-right" id="todayOnTimePercentage">0%</div>
              </div>
              
              <div>
                <div class="flex justify-between mb-1">
                  <span class="font-medium">Terlambat</span>
                  <span class="font-bold text-red-600" id="todayLateCount">0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div id="todayLateBar" class="bg-red-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-1 text-right" id="todayLatePercentage">0%</div>
              </div>
            </div>
            
            <div class="mt-6">
              <div class="flex justify-between items-center mb-2">
                <h4 class="font-semibold">Aktivitas Terakhir</h4>
                <button onclick="loadLiveAbsenData()" class="text-sm text-blue-600 hover:text-blue-800">
                  Lihat Semua
                </button>
              </div>
              <div class="space-y-2" id="lastActivities">
                <!-- Data akan diisi oleh JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Log Sistem Section -->
    <div id="logsSection" class="section hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Log Sistem</h2>
        <div class="flex space-x-2">
          <button onclick="loadLogsData()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">
            <i class="fas fa-sync-alt mr-2"></i> Refresh
          </button>
          <button onclick="clearLogs()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
            <i class="fas fa-trash-alt mr-2"></i> Clear Logs
          </button>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 border-b">
          <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-4">
            <div>
              <label for="logActionFilter" class="block text-gray-700 mb-1 text-sm">Action:</label>
              <select id="logActionFilter" class="px-3 py-1 border rounded-lg">
                <option value="">Semua</option>
                <option value="login">Login</option>
                <option value="scan_rfid">Scan RFID</option>
                <option value="update_settings">Update Settings</option>
                <!-- Diisi oleh JavaScript -->
              </select>
            </div>
            <div>
              <label for="logStatusFilter" class="block text-gray-700 mb-1 text-sm">Status:</label>
              <select id="logStatusFilter" class="px-3 py-1 border rounded-lg">
                <option value="">Semua</option>
                <option value="Success">Success</option>
                <option value="Error">Error</option>
              </select>
            </div>
            <div>
              <label for="logDateFilter" class="block text-gray-700 mb-1 text-sm">Tanggal:</label>
              <input type="date" id="logDateFilter" class="px-3 py-1 border rounded-lg">
            </div>
            <button onclick="filterLogs()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg mt-auto">
              <i class="fas fa-filter mr-2"></i> Filter
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="py-3 px-4 text-left">Timestamp</th>
                <th class="py-3 px-4 text-left">Action</th>
                <th class="py-3 px-4 text-left">Status</th>
                <th class="py-3 px-4 text-left">User</th>
                <th class="py-3 px-4 text-left">Details</th>
              </tr>
            </thead>
            <tbody id="logsTableBody">
              <!-- Data akan diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t flex justify-between items-center">
          <div id="logsTableInfo" class="text-sm text-gray-600"></div>
          <div class="flex space-x-2">
            <button id="prevLogPageBtn" onclick="prevLogPage()" class="px-3 py-1 border rounded-lg disabled:opacity-50" disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="logPageInfo" class="px-3 py-1">1/1</span>
            <button id="nextLogPageBtn" onclick="nextLogPage()" class="px-3 py-1 border rounded-lg disabled:opacity-50" disabled>
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Tambah/Edit Siswa -->
  <div id="siswaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="siswaModalTitle" class="text-xl font-bold"></h3>
        <button onclick="hideModal('siswaModal')" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="siswaForm" onsubmit="event.preventDefault(); submitSiswaForm();">
        <input type="hidden" id="siswaId">
        
        <div class="mb-4">
          <label for="siswaNIS" class="block text-gray-700 mb-2">NIS</label>
          <input type="text" id="siswaNIS" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        
        <div class="mb-4">
          <label for="siswaNama" class="block text-gray-700 mb-2">Nama</label>
          <input type="text" id="siswaNama" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        
        <div class="mb-4">
          <label for="siswaKelas" class="block text-gray-700 mb-2">Kelas</label>
          <input type="text" id="siswaKelas" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        
        <div class="mb-4">
          <label for="siswaRFID" class="block text-gray-700 mb-2">RFID</label>
          <input type="text" id="siswaRFID" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        
        <div class="mb-4">
          <label for="siswaStatus" class="block text-gray-700 mb-2">Status</label>
          <select id="siswaStatus" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="Aktif">Aktif</option>
            <option value="Non-Aktif">Non-Aktif</option>
          </select>
        </div>
        
        <div class="flex justify-end space-x-2 mt-6">
          <button type="button" onclick="hideModal('siswaModal')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
            Batal
          </button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
            Simpan
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Tambah Hari Libur -->
  <div id="liburModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Tambah Hari Libur</h3>
        <button onclick="hideModal('liburModal')" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form id="liburForm" onsubmit="event.preventDefault(); submitLiburForm();">
        <div class="mb-4">
          <label for="liburTanggal" class="block text-gray-700 mb-2">Tanggal</label>
          <input type="date" id="liburTanggal" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        
        <div class="mb-4">
          <label for="liburKeterangan" class="block text-gray-700 mb-2">Keterangan</label>
          <input type="text" id="liburKeterangan" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        
        <div class="flex justify-end space-x-2 mt-6">
          <button type="button" onclick="hideModal('liburModal')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
            Batal
          </button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
            Simpan
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Konfirmasi -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="confirmModalTitle" class="text-xl font-bold">Konfirmasi</h3>
        <button onclick="hideModal('confirmModal')" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="mb-6">
        <p id="confirmModalMessage"></p>
      </div>
      
      <div class="flex justify-end space-x-2">
        <button type="button" onclick="hideModal('confirmModal')" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
          Batal
        </button>
        <button type="button" id="confirmModalButton" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
          Konfirmasi
        </button>
      </div>
    </div>
  </div>

  <script>
    // Konfigurasi - GANTI DENGAN URL WEB APP ANDA
    const APPSCRIPT_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwOKtE_EaBgWGC0t9KllsderbPELc1s_p026a2Kcp35u_8_wiyhOBAIfyLHZ_dq_6T6/exec';
    
    // Variabel global
    let authToken = null;
    let currentUser = null;
    let siswaData = [];
    let absenData = [];
    let liburData = [];
    let logsData = [];
    let settings = {};
    let kelasList = [];
    
    // Pagination
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentLogPage = 1;
    const logsPerPage = 10;
    
    // Inisialisasi saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
      // Setup event listeners
      setupEventListeners();
      
      // Load pengaturan pertama kali
      loadSettings();
      
      // Update waktu secara real-time
      updateClock();
      setInterval(updateClock, 1000);
      
      // Setup RFID input
      setupRFIDInput();
      
      // Cek koneksi internet
      checkConnection();
      window.addEventListener('online', checkConnection);
      window.addEventListener('offline', checkConnection);
      
      // Tampilkan section berdasarkan hash URL
      const hash = window.location.hash.substring(1) || 'live';
      showSection(hash);
    });
    
    // ==================== FUNGSI UTAMA ====================
    function setupEventListeners() {
      // Mobile menu button
      document.getElementById('mobileMenuButton').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('open');
      });
      
      // RFID input
      document.getElementById('rfidInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          handleRFIDScan(this.value);
          this.value = '';
        }
      });
      
      // Filter logs
      document.getElementById('logActionFilter').addEventListener('change', filterLogs);
      document.getElementById('logStatusFilter').addEventListener('change', filterLogs);
      document.getElementById('logDateFilter').addEventListener('change', filterLogs);
      
      // Manual absen waktu
      document.getElementById('manualWaktu').value = new Date().toISOString().slice(0, 16);
    }
    
    function checkConnection() {
      const isOnline = navigator.onLine;
      const connectionStatus = document.getElementById('connectionStatus');
      
      if (isOnline) {
        connectionStatus.classList.add('hidden');
      } else {
        connectionStatus.classList.remove('hidden');
      }
    }
    
    function showLoading() {
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
    
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification fixed bottom-4 right-4 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white px-6 py-3 rounded-lg shadow-lg`;
      notification.classList.remove('hidden');
      
      // Sembunyikan notifikasi setelah 3 detik
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 3000);
    }
    
    function showModal(modalId, title = '') {
      document.getElementById(modalId).classList.remove('hidden');
      if (title && document.getElementById(modalId + 'Title')) {
        document.getElementById(modalId + 'Title').textContent = title;
      }
    }
    
    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }
    
    function showConfirmModal(title, message, callback) {
      document.getElementById('confirmModalTitle').textContent = title;
      document.getElementById('confirmModalMessage').textContent = message;
      
      const confirmBtn = document.getElementById('confirmModalButton');
      confirmBtn.onclick = function() {
        callback();
        hideModal('confirmModal');
      };
      
      showModal('confirmModal');
    }
    
    function showSection(sectionId) {
      // Sembunyikan semua section
      document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Tampilkan section yang dipilih
      document.getElementById(sectionId + 'Section').classList.remove('hidden');
      
      // Update URL hash
      window.location.hash = sectionId;
      
      // Load data sesuai section
      switch(sectionId) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'siswa':
          loadSiswaData();
          break;
        case 'absen':
          loadAbsenData();
          break;
        case 'settings':
          loadSettingsForm();
          break;
        case 'libur':
          loadLiburData();
          break;
        case 'manual':
          loadManualAbsenForm();
          break;
        case 'live':
          loadLiveAbsenData();
          break;
        case 'logs':
          loadLogsData();
          break;
      }
      
      // Tutup sidebar di mobile
      if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.remove('open');
      }
    }
    
    function updateClock() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const dateStr = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      
      document.getElementById('currentTime').textContent = timeStr;
      document.getElementById('currentDate').textContent = dateStr;
    }
    
    // ==================== FUNGSI API REQUEST ====================
    async function makeRequest(action, data = {}, method = 'GET') {
      const url = new URL(APPSCRIPT_WEBAPP_URL);
      const options = {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        redirect: 'follow'
      };
    
      // Tambahkan token auth jika ada
      if (authToken) {
        options.headers['Authorization'] = `Bearer ${authToken}`;
      }
    
      // Handle GET vs POST
      if (method === 'GET') {
        url.searchParams.append('action', action);
        for (const key in data) {
          url.searchParams.append(key, data[key]);
        }
      } else {
        options.body = JSON.stringify({ action, ...data });
      }
    
      showLoading();
      
      try {
        const response = await fetch(url.toString(), options);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }
    
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Request failed');
        }
    
        return result.data;
      } catch (error) {
        console.error('Request error:', error);
        showNotification(error.message || 'Gagal terhubung ke server', 'error');
        throw error;
      } finally {
        hideLoading();
      }
    }
    
    // ==================== FUNGSI AUTHENTIKASI ====================
    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
    
      if (!username || !password) {
        showNotification('Username dan password harus diisi', 'error');
        return;
      }
    
      try {
        const result = await makeRequest('login', { username, password }, 'POST');
        authToken = result.token;
        currentUser = result.user;
        
        // Update UI setelah login
        document.getElementById('adminMenu').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('loginSection').classList.add('hidden');
        
        // Update user info di sidebar
        if (currentUser && currentUser.name) {
          document.getElementById('appTitle').textContent += ` - ${currentUser.name}`;
        }
        
        // Load data yang diperlukan
        await loadSettings();
        await loadDashboardData();
        
        showNotification('Login berhasil');
      } catch (error) {
        console.error('Login failed:', error);
      }
    }
    
    function logout() {
      authToken = null;
      currentUser = null;
      
      // Update UI setelah logout
      document.getElementById('adminMenu').classList.add('hidden');
      document.getElementById('logoutBtn').classList.add('hidden');
      document.getElementById('loginBtn').classList.remove('hidden');
      
      // Reset form login
      document.getElementById('loginForm').reset();
      
      // Tampilkan live absen
      showSection('live');
      
      showNotification('Anda telah logout');
    }
    
    // ==================== FUNGSI DASHBOARD ====================
    async function loadDashboardData() {
      try {
        // Load data siswa
        siswaData = await makeRequest('get_siswa');
        const totalSiswa = siswaData.length;
        const activeSiswa = siswaData.filter(s => s.status === 'Aktif').length;
        
        document.getElementById('totalSiswa').textContent = totalSiswa;
        document.getElementById('activeSiswa').textContent = activeSiswa;
        
        // Load data absen hari ini
        const today = new Date().toISOString().split('T')[0];
        absenData = await makeRequest('get_absen', { tanggal: today });
        
        const totalAbsen = absenData.length;
        const totalTerlambat = absenData.filter(a => a.status === 'Terlambat').length;
        const totalOnTime = absenData.filter(a => a.status === 'Tepat Waktu').length;
        
        const presentPercentage = totalSiswa > 0 ? Math.round((totalAbsen / activeSiswa) * 100) : 0;
        const latePercentage = totalAbsen > 0 ? Math.round((totalTerlambat / totalAbsen) * 100) : 0;
        
        document.getElementById('absenHariIni').textContent = totalAbsen;
        document.getElementById('terlambatHariIni').textContent = totalTerlambat;
        document.getElementById('presentPercentage').textContent = presentPercentage;
        document.getElementById('latePercentage').textContent = latePercentage;
        
        // Tampilkan aktivitas terakhir
        renderLastActivities(absenData.slice(0, 5), 'lastActivityTable');
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }
    
    // ==================== FUNGSI DATA SISWA ====================
    async function loadSiswaData() {
      try {
        siswaData = await makeRequest('get_siswa');
        
        // Ekstrak daftar kelas unik
        kelasList = [...new Set(siswaData.map(s => s.kelas))].sort();
        
        // Render filter kelas di absensi
        const kelasFilter = document.getElementById('filterKelas');
        kelasFilter.innerHTML = '<option value="">Semua Kelas</option>';
        kelasList.forEach(kelas => {
          const option = document.createElement('option');
          option.value = kelas;
          option.textContent = kelas;
          kelasFilter.appendChild(option);
        });
        
        renderSiswaTable();
      } catch (error) {
        console.error('Error loading siswa data:', error);
      }
    }
    
    function renderSiswaTable() {
      const tableBody = document.getElementById('siswaTableBody');
      const filter = document.getElementById('siswaFilter').value;
      const searchTerm = document.getElementById('siswaSearch').value.toLowerCase();
      
      // Filter data
      let filteredData = siswaData;
      
      if (filter === 'active') {
        filteredData = filteredData.filter(s => s.status === 'Aktif');
      } else if (filter === 'inactive') {
        filteredData = filteredData.filter(s => s.status !== 'Aktif');
      }
      
      if (searchTerm) {
        filteredData = filteredData.filter(s => 
          s.nis.toLowerCase().includes(searchTerm) || 
          s.nama.toLowerCase().includes(searchTerm) ||
          s.kelas.toLowerCase().includes(searchTerm) ||
          s.rfid.toLowerCase().includes(searchTerm)
        );
      }
      
      // Pagination
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const paginatedData = filteredData.slice(startIndex, startIndex + itemsPerPage);
      
      tableBody.innerHTML = '';
      
      paginatedData.forEach(siswa => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="py-3 px-4 border-b">${siswa.nis}</td>
          <td class="py-3 px-4 border-b">${siswa.nama}</td>
          <td class="py-3 px-4 border-b">${siswa.kelas}</td>
          <td class="py-3 px-4 border-b">${siswa.rfid}</td>
          <td class="py-3 px-4 border-b">
            <span class="${siswa.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} text-xs font-medium px-2.5 py-0.5 rounded">
              ${siswa.status}
            </span>
          </td>
          <td class="py-3 px-4 border-b">
            <button onclick="editSiswa('${siswa.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="confirmDeleteSiswa('${siswa.id}')" class="text-red-600 hover:text-red-800">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      // Update info pagination
      document.getElementById('pageInfo').textContent = `${currentPage}/${totalPages}`;
      document.getElementById('prevPageBtn').disabled = currentPage <= 1;
      document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
      document.getElementById('siswaTableInfo').textContent = `Menampilkan ${paginatedData.length} dari ${filteredData.length} siswa`;
    }
    
    function filterSiswaTable() {
      currentPage = 1;
      renderSiswaTable();
    }
    
    function searchSiswa() {
      currentPage = 1;
      renderSiswaTable();
    }
    
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderSiswaTable();
      }
    }
    
    function nextPage() {
      const totalPages = Math.ceil(siswaData.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderSiswaTable();
      }
    }
    
    function showAddSiswaModal() {
      document.getElementById('siswaForm').reset();
      document.getElementById('siswaId').value = '';
      document.getElementById('siswaStatus').value = 'Aktif';
      document.getElementById('siswaModalTitle').textContent = 'Tambah Siswa Baru';
      showModal('siswaModal');
    }
    
    function editSiswa(siswaId) {
      const siswa = siswaData.find(s => s.id === siswaId);
      if (!siswa) return;
      
      document.getElementById('siswaId').value = siswa.id;
      document.getElementById('siswaNIS').value = siswa.nis;
      document.getElementById('siswaNama').value = siswa.nama;
      document.getElementById('siswaKelas').value = siswa.kelas;
      document.getElementById('siswaRFID').value = siswa.rfid;
      document.getElementById('siswaStatus').value = siswa.status;
      
      document.getElementById('siswaModalTitle').textContent = 'Edit Data Siswa';
      showModal('siswaModal');
    }
    
    function confirmDeleteSiswa(siswaId) {
      const siswa = siswaData.find(s => s.id === siswaId);
      if (!siswa) return;
      
      showConfirmModal(
        'Konfirmasi Hapus Siswa',
        `Apakah Anda yakin ingin menghapus siswa ${siswa.nama} (${siswa.nis})?`,
        () => deleteSiswa(siswaId)
      );
    }
    
    async function submitSiswaForm() {
      const formData = {
        id: document.getElementById('siswaId').value,
        nis: document.getElementById('siswaNIS').value,
        nama: document.getElementById('siswaNama').value,
        kelas: document.getElementById('siswaKelas').value,
        rfid: document.getElementById('siswaRFID').value,
        status: document.getElementById('siswaStatus').value
      };
      
      try {
        if (formData.id) {
          // Update siswa
          await makeRequest('update_siswa', formData);
          showNotification('Data siswa berhasil diperbarui');
        } else {
          // Tambah siswa baru
          await makeRequest('add_siswa', formData);
          showNotification('Siswa baru berhasil ditambahkan');
        }
        
        // Reload data siswa
        await loadSiswaData();
        hideModal('siswaModal');
      } catch (error) {
        console.error('Error submitting siswa form:', error);
      }
    }
    
    async function deleteSiswa(siswaId) {
      try {
        await makeRequest('delete_siswa', { id: siswaId });
        showNotification('Siswa berhasil dihapus');
        await loadSiswaData();
      } catch (error) {
        console.error('Error deleting siswa:', error);
      }
    }
    
    // ==================== FUNGSI REKAP ABSEN ====================
    async function loadAbsenData() {
      try {
        const filterDate = document.getElementById('filterDate').value;
        const filterKelas = document.getElementById('filterKelas').value;
        const filterStatus = document.getElementById('filterStatus').value;
        
        const params = {};
        if (filterDate) params.tanggal = filterDate;
        if (filterKelas) params.kelas = filterKelas;
        if (filterStatus) params.status = filterStatus;
        
        absenData = await makeRequest('get_absen', params);
        renderAbsenTable();
      } catch (error) {
        console.error('Error loading absen data:', error);
      }
    }
    
    function renderAbsenTable() {
      const tableBody = document.getElementById('absenTableBody');
      tableBody.innerHTML = '';
      
      absenData.forEach(absen => {
        const waktu = new Date(absen.waktu);
        const waktuStr = waktu.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="py-2 px-4 border-b">${absen.nis}</td>
          <td class="py-2 px-4 border-b">${absen.nama}</td>
          <td class="py-2 px-4 border-b">${absen.kelas}</td>
          <td class="py-2 px-4 border-b">${waktuStr}</td>
          <td class="py-2 px-4 border-b">
            <span class="${absen.status === 'Terlambat' ? 'bg-red-100 text-red-800' : 
                         absen.status === 'Awal' ? 'bg-blue-100 text-blue-800' : 
                         'bg-green-100 text-green-800'} text-xs font-medium px-2.5 py-0.5 rounded">
              ${absen.status}
            </span>
          </td>
          <td class="py-2 px-4 border-b">${absen.metode || (absen.rfid === 'MANUAL' ? 'Manual' : 'RFID')}</td>
        `;
        tableBody.appendChild(row);
      });
      
      document.getElementById('absenTableInfo').textContent = `Menampilkan ${absenData.length} absen`;
    }
    
    function resetFilter() {
      document.getElementById('filterDate').value = '';
      document.getElementById('filterKelas').value = '';
      document.getElementById('filterStatus').value = '';
      loadAbsenData();
    }
    
    async function exportAbsenData() {
      try {
        const filterDate = document.getElementById('filterDate').value;
        const filterKelas = document.getElementById('filterKelas').value;
        const filterStatus = document.getElementById('filterStatus').value;
        
        const params = {};
        if (filterDate) params.tanggal = filterDate;
        if (filterKelas) params.kelas = filterKelas;
        if (filterStatus) params.status = filterStatus;
        
        const data = await makeRequest('get_absen', params);
        
        // Format data untuk CSV
        let csv = 'NIS,Nama,Kelas,Waktu,Status,Metode\n';
        data.forEach(absen => {
          const waktu = new Date(absen.waktu).toLocaleString('id-ID');
          csv += `"${absen.nis}","${absen.nama}","${absen.kelas}","${waktu}","${absen.status}","${absen.metode || (absen.rfid === 'MANUAL' ? 'Manual' : 'RFID')}"\n`;
        });
        
        // Buat file dan download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `rekap_absen_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Data absen berhasil diexport');
      } catch (error) {
        console.error('Error exporting absen data:', error);
        showNotification('Gagal export data absen', 'error');
      }
    }
    
    // ==================== FUNGSI PENGATURAN ====================
    async function loadSettings() {
      try {
        settings = await makeRequest('get_settings');
        
        // Update UI dengan pengaturan
        document.getElementById('appTitle').textContent = settings.judul_web;
        document.getElementById('logo').src = settings.logo_url || 'https://via.placeholder.com/40';
        
        // Update judul halaman
        document.title = settings.judul_web;
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }
    
    function loadSettingsForm() {
      document.getElementById('jamMasuk').value = settings.jam_masuk;
      document.getElementById('batasTerlambat').value = settings.batas_terlambat;
      document.getElementById('judulWeb').value = settings.judul_web;
      document.getElementById('deskripsiWeb').value = settings.deskripsi_web;
      document.getElementById('logoUrl').value = settings.logo_url;
      document.getElementById('modeAbsen').value = settings.mode_absen || 'normal';
      
      // Update logo preview
      const logoPreview = document.getElementById('logoPreview');
      if (settings.logo_url) {
        logoPreview.src = settings.logo_url;
        logoPreview.classList.remove('hidden');
      } else {
        logoPreview.classList.add('hidden');
      }
    }
    
    function resetSettingsForm() {
      loadSettingsForm();
      showNotification('Form pengaturan telah direset');
    }
    
    function testLogoUrl() {
      const url = document.getElementById('logoUrl').value;
      if (!url) return;
      
      const logoPreview = document.getElementById('logoPreview');
      logoPreview.src = url;
      logoPreview.onload = function() {
        logoPreview.classList.remove('hidden');
        showNotification('Logo berhasil dimuat', 'success');
      };
      logoPreview.onerror = function() {
        logoPreview.classList.add('hidden');
        showNotification('Gagal memuat logo', 'error');
      };
    }
    
    async function updateSettings() {
      const formData = {
        jam_masuk: document.getElementById('jamMasuk').value,
        batas_terlambat: document.getElementById('batasTerlambat').value,
        judul_web: document.getElementById('judulWeb').value,
        deskripsi_web: document.getElementById('deskripsiWeb').value,
        logo_url: document.getElementById('logoUrl').value,
        mode_absen: document.getElementById('modeAbsen').value
      };
      
      try {
        await makeRequest('update_settings', formData);
        showNotification('Pengaturan berhasil diperbarui');
        
        // Reload settings
        await loadSettings();
      } catch (error) {
        console.error('Error updating settings:', error);
      }
    }
    
    // ==================== FUNGSI HARI LIBUR ====================
    async function loadLiburData() {
      try {
        liburData = await makeRequest('get_libur');
        renderLiburTable();
      } catch (error) {
        console.error('Error loading libur data:', error);
      }
    }
    
    function renderLiburTable() {
      const tableBody = document.getElementById('liburTableBody');
      tableBody.innerHTML = '';
      
      liburData.forEach(libur => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="py-3 px-4 border-b">${libur.tanggal_str}</td>
          <td class="py-3 px-4 border-b">${libur.keterangan}</td>
          <td class="py-3 px-4 border-b">
            <button onclick="confirmDeleteLibur('${libur.id}')" class="text-red-600 hover:text-red-800">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    function showAddLiburModal() {
      document.getElementById('liburForm').reset();
      document.getElementById('liburTanggal').valueAsDate = new Date();
      showModal('liburModal');
    }
    
    function confirmDeleteLibur(liburId) {
      const libur = liburData.find(l => l.id === liburId);
      if (!libur) return;
      
      showConfirmModal(
        'Konfirmasi Hapus Hari Libur',
        `Apakah Anda yakin ingin menghapus hari libur ${libur.tanggal_str} (${libur.keterangan})?`,
        () => deleteLibur(liburId)
      );
    }
    
    async function submitLiburForm() {
      const formData = {
        action: 'add',
        tanggal: document.getElementById('liburTanggal').value,
        keterangan: document.getElementById('liburKeterangan').value
      };
      
      try {
        await makeRequest('update_libur', formData);
        showNotification('Hari libur berhasil ditambahkan');
        
        // Reload data libur
        await loadLiburData();
        hideModal('liburModal');
      } catch (error) {
        console.error('Error submitting libur form:', error);
      }
    }
    
    async function deleteLibur(liburId) {
      try {
        await makeRequest('update_libur', { action: 'delete', id: liburId });
        showNotification('Hari libur berhasil dihapus');
        await loadLiburData();
      } catch (error) {
        console.error('Error deleting libur:', error);
      }
    }
    
    // ==================== FUNGSI ABSEN MANUAL ====================
    async function loadManualAbsenForm() {
      try {
        if (siswaData.length === 0) {
          siswaData = await makeRequest('get_siswa');
        }
        
        const select = document.getElementById('manualSiswa');
        select.innerHTML = '<option value="">-- Pilih Siswa --</option>';
        
        siswaData.filter(s => s.status === 'Aktif').forEach(siswa => {
          const option = document.createElement('option');
          option.value = JSON.stringify({
            siswa_id: siswa.id,
            nis: siswa.nis,
            nama: siswa.nama,
            kelas: siswa.kelas
          });
          option.textContent = `${siswa.nis} - ${siswa.nama} (${siswa.kelas})`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading manual absen form:', error);
      }
    }
    
    async function submitManualAbsen() {
      const siswaSelect = document.getElementById('manualSiswa');
      const selectedOption = siswaSelect.options[siswaSelect.selectedIndex];
      
      if (!selectedOption.value) {
        showNotification('Pilih siswa terlebih dahulu', 'error');
        return;
      }
      
      const siswa = JSON.parse(selectedOption.value);
      const statusSelect = document.getElementById('manualStatus');
      const waktuInput = document.getElementById('manualWaktu');
      
      let status = statusSelect.value;
      let waktu = new Date(waktuInput.value || new Date());
      
      // Jika status auto, tentukan berdasarkan waktu
      if (status === 'auto') {
        const settings = await makeRequest('get_settings');
        const jamMasuk = new Date();
        const [hours, minutes] = settings.jam_masuk.split(':').map(Number);
        jamMasuk.setHours(hours, minutes, 0, 0);
        
        const selisihMenit = (waktu - jamMasuk) / (1000 * 60);
        const batasTerlambat = settings.batas_terlambat || 15;
        
        if (selisihMenit > batasTerlambat) {
          status = 'Terlambat';
        } else if (selisihMenit < 0) {
          status = 'Awal';
        } else {
          status = 'Tepat Waktu';
        }
      }
      
      try {
        const result = await makeRequest('manual_absen', { 
          ...siswa, 
          status,
          waktu: waktu.toISOString()
        });
        
        showNotification(`Absen manual berhasil: ${siswa.nama} (${result.status})`);
        document.getElementById('manualAbsenForm').reset();
        loadLiveAbsenData();
      } catch (error) {
        console.error('Error submitting manual absen:', error);
      }
    }
    
    // ==================== FUNGSI LIVE ABSEN ====================
    function setupRFIDInput() {
      const rfidInput = document.getElementById('rfidInput');
      
      rfidInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          handleRFIDScan(this.value);
          this.value = '';
        }
      });
    }
    
    async function handleRFIDScan(rfid) {
      try {
        const result = await makeRequest('scan_rfid', { rfid: rfid });
        
        // Tampilkan notifikasi
        showNotification(`Absen berhasil: ${result.siswa.nama} (${result.status})`);
        
        // Update last scan info
        document.getElementById('lastScanInfo').innerHTML = `
          <div class="font-bold">${result.siswa.nama}</div>
          <div>${result.siswa.kelas} - ${result.siswa.nis}</div>
          <div class="text-sm">${result.waktu} - <span class="${result.status === 'Terlambat' ? 'text-red-600' : 
                                                              result.status === 'Awal' ? 'text-blue-600' : 
                                                              'text-green-600'}">${result.status}</span></div>
        `;
        
        // Reload live absen data
        await loadLiveAbsenData();
      } catch (error) {
        console.error('Error handling RFID scan:', error);
      }
    }
    
    async function loadLiveAbsenData() {
      try {
        const today = new Date().toISOString().split('T')[0];
        absenData = await makeRequest('get_absen', { tanggal: today });
        
        const totalAbsen = absenData.length;
        const totalOnTime = absenData.filter(a => a.status === 'Tepat Waktu').length;
        const totalLate = absenData.filter(a => a.status === 'Terlambat').length;
        const totalEarly = absenData.filter(a => a.status === 'Awal').length;
        
        // Update stats
        document.getElementById('todayAbsenCount').textContent = totalAbsen;
        document.getElementById('todayOnTimeCount').textContent = totalOnTime;
        document.getElementById('todayLateCount').textContent = totalLate;
        
        // Update progress bars
        const activeSiswa = siswaData.length > 0 ? 
          siswaData.filter(s => s.status === 'Aktif').length : 
          (await makeRequest('get_siswa')).filter(s => s.status === 'Aktif').length;
        
        const absenPercent = activeSiswa > 0 ? Math.round((totalAbsen / activeSiswa) * 100) : 0;
        const onTimePercent = totalAbsen > 0 ? Math.round((totalOnTime / totalAbsen) * 100) : 0;
        const latePercent = totalAbsen > 0 ? Math.round((totalLate / totalAbsen) * 100) : 0;
        
        document.getElementById('todayAbsenBar').style.width = `${absenPercent}%`;
        document.getElementById('todayOnTimeBar').style.width = `${onTimePercent}%`;
        document.getElementById('todayLateBar').style.width = `${latePercent}%`;
        
        document.getElementById('todayAbsenPercentage').textContent = `${absenPercent}%`;
        document.getElementById('todayOnTimePercentage').textContent = `${onTimePercent}%`;
        document.getElementById('todayLatePercentage').textContent = `${latePercent}%`;
        
        // Update last activities
        renderLastActivities(absenData.slice(0, 5), 'lastActivities');
        
        // Cek hari libur
        const isLibur = await makeRequest('get_libur').then(libur => {
          const todayStr = new Date().toISOString().split('T')[0];
          return libur.some(l => l.tanggal_str === todayStr);
        });
        
        const liburInfo = document.getElementById('liburInfo');
        if (isLibur) {
          liburInfo.classList.remove('hidden');
        } else {
          liburInfo.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error loading live absen data:', error);
      }
    }
    
    function renderLastActivities(activities, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      activities.forEach(absen => {
        const waktu = new Date(absen.waktu);
        const waktuStr = waktu.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        
        const activity = document.createElement('div');
        activity.className = 'p-2 border-b';
        activity.innerHTML = `
          <div class="flex justify-between">
            <span class="font-medium">${absen.nama}</span>
            <span class="text-sm ${absen.status === 'Terlambat' ? 'text-red-600' : 
                                 absen.status === 'Awal' ? 'text-blue-600' : 
                                 'text-green-600'}">${absen.status}</span>
          </div>
          <div class="flex justify-between text-sm text-gray-600">
            <span>${absen.kelas} - ${absen.nis}</span>
            <span>${waktuStr}</span>
          </div>
        `;
        container.appendChild(activity);
      });
    }
    
    // ==================== FUNGSI LOG SISTEM ====================
    async function loadLogsData() {
      try {
        logsData = await makeRequest('get_logs');
        currentLogPage = 1;
        filterLogs();
      } catch (error) {
        console.error('Error loading logs data:', error);
      }
    }
    
    function filterLogs() {
      const actionFilter = document.getElementById('logActionFilter').value;
      const statusFilter = document.getElementById('logStatusFilter').value;
      const dateFilter = document.getElementById('logDateFilter').value;
      
      let filteredData = logsData;
      
      if (actionFilter) {
        filteredData = filteredData.filter(log => log.action === actionFilter);
      }
      
      if (statusFilter) {
        filteredData = filteredData.filter(log => log.status === statusFilter);
      }
      
      if (dateFilter) {
        const filterDate = new Date(dateFilter).toDateString();
        filteredData = filteredData.filter(log => 
          new Date(log.timestamp).toDateString() === filterDate
        );
      }
      
      renderLogsTable(filteredData);
    }
    
    function renderLogsTable(data) {
      const tableBody = document.getElementById('logsTableBody');
      const totalPages = Math.ceil(data.length / logsPerPage);
      const startIndex = (currentLogPage - 1) * logsPerPage;
      const paginatedData = data.slice(startIndex, startIndex + logsPerPage);
      
      tableBody.innerHTML = '';
      
      paginatedData.forEach(log => {
        const timestamp = new Date(log.timestamp);
        const timestampStr = timestamp.toLocaleString('id-ID');
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
          <td class="py-3 px-4 border-b">${timestampStr}</td>
          <td class="py-3 px-4 border-b">${log.action}</td>
          <td class="py-3 px-4 border-b">
            <span class="${log.status === 'Success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} text-xs font-medium px-2.5 py-0.5 rounded">
              ${log.status}
            </span>
          </td>
          <td class="py-3 px-4 border-b">${log.user || '-'}</td>
          <td class="py-3 px-4 border-b">
            <button onclick="showLogDetails('${log.timestamp}', ${JSON.stringify(log.details)})" class="text-blue-600 hover:text-blue-800">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      // Update info pagination
      document.getElementById('logPageInfo').textContent = `${currentLogPage}/${totalPages}`;
      document.getElementById('prevLogPageBtn').disabled = currentLogPage <= 1;
      document.getElementById('nextLogPageBtn').disabled = currentLogPage >= totalPages;
      document.getElementById('logsTableInfo').textContent = `Menampilkan ${paginatedData.length} dari ${data.length} log`;
    }
    
    function prevLogPage() {
      if (currentLogPage > 1) {
        currentLogPage--;
        filterLogs();
      }
    }
    
    function nextLogPage() {
      const filteredData = getFilteredLogs();
      const totalPages = Math.ceil(filteredData.length / logsPerPage);
      
      if (currentLogPage < totalPages) {
        currentLogPage++;
        filterLogs();
      }
    }
    
    function showLogDetails(timestamp, details) {
      let detailsStr = '';
      
      if (typeof details === 'object') {
        detailsStr = JSON.stringify(details, null, 2);
      } else {
        detailsStr = details;
      }
      
      showConfirmModal(
        `Detail Log - ${new Date(timestamp).toLocaleString()}`,
        `<pre class="bg-gray-100 p-2 rounded overflow-auto max-h-60">${detailsStr}</pre>`,
        () => {}
      );
      
      // Ubah tombol konfirmasi menjadi tutup
      const confirmBtn = document.getElementById('confirmModalButton');
      confirmBtn.textContent = 'Tutup';
      confirmBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg';
    }
    
    async function clearLogs() {
      showConfirmModal(
        'Konfirmasi Clear Logs',
        'Apakah Anda yakin ingin menghapus semua log sistem?',
        async () => {
          try {
            await makeRequest('clear_logs');
            showNotification('Log sistem berhasil dihapus');
            loadLogsData();
          } catch (error) {
            console.error('Error clearing logs:', error);
            showNotification('Gagal menghapus log sistem', 'error');
          }
        }
      );
    }
    
    function getFilteredLogs() {
      const actionFilter = document.getElementById('logActionFilter').value;
      const statusFilter = document.getElementById('logStatusFilter').value;
      const dateFilter = document.getElementById('logDateFilter').value;
      
      let filteredData = logsData;
      
      if (actionFilter) {
        filteredData = filteredData.filter(log => log.action === actionFilter);
      }
      
      if (statusFilter) {
        filteredData = filteredData.filter(log => log.status === statusFilter);
      }
      
      if (dateFilter) {
        const filterDate = new Date(dateFilter).toDateString();
        filteredData = filteredData.filter(log => 
          new Date(log.timestamp).toDateString() === filterDate
        );
      }
      
      return filteredData;
    }
  </script>
</body>
</html>
